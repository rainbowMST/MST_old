# 04-03、网络：TCP和UDP

## Socket 

Socket 是应用层与 TCP/IP 协议族通信的中间软件抽象层，它是一组接口。在设计模式中，Socket其实就是一个门面模式，它把复杂的 TCP/IP 协议族隐藏在 Socket 接口后面，对用户来说，一组简单的接口就是全部，让Socket去组织数据，以符合指定的协议。

## TCP和UDP

### 1、TCP和UDP的区别

TCP（Transmission Control Protocol ==传输控制协议==）
是一种面向连接的、可靠的、基于字节流的传输层通信协议。

UDP (User Datagram Protocol ==用户数据报协议==）
是 OSI（Open System Interconnection，开放式系统互联）参考模型中一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。

1. TCP 是面向连接的传输控制协议，而UDP提供了无链接的数据报服务
2. TCP 首部开销20字节, UDP首部开销8字节
3. TCP 面向连接，提供可靠的数据服务，逻辑通信信道是全双工的可靠信道，UDP则是不可靠信道
4. TCP 的连接只能是点到点的，UDP 支持一对一、多对一、多对多的交互通信
5. UDP 没有拥塞机制，因此网络出现拥堵不会使源主机的发送效率降低（有利于实时会议视频等）

```
------------------------------------------------------------
单工、半双工、全双工、
单工数据传输只支持数据在一个方向上传输；
半双工数据传输允许数据在两个方向上传输，但是，在某一时刻，只允许数据在一个方向上传输，它实际上是一种切换方向的单工通信；
全双工数据通信允许数据同时在两个方向上传输
------------------------------------------------------------
```

### 2、TCP三次握手机制，发送的包叫啥

![](http://oy7b0gogl.bkt.clouddn.com/三次握手.png)

答：客户端发送的确认包 ack 

1. 第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；
2. 第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；
3. 第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。断开连接时服务器和客户端均可以主动发起断开TCP连接的请求，断开过程需要经过“四次握手”（过程就不细写了，就是服务器和客户端交互，最终确定断开） 

### 3、TCP四次挥手机制

![](http://oy7b0gogl.bkt.clouddn.com/四次挥手.png)

1. 第一次分手：主机1（可以使客户端，也可以是服务器端），设置Sequence Number和Acknowledgment Number，向主机2发送一个FIN报文段；此时，主机1进入FIN_WAIT_1状态；这表示主机1没有数据要发送给主机2了；
2. 第二次分手：主机2收到了主机1发送的FIN报文段，向主机1回一个ACK报文段，Acknowledgment Number为Sequence Number加1；主机1进入FIN_WAIT_2状态；主机2告诉主机1，我“同意”你的关闭请求；
3. 第三次分手：主机2向主机1发送FIN报文段，请求关闭连接，同时主机2进入LAST_ACK状态；
4. 第四次分手：主机1收到主机2发送的FIN报文段，向主机2发送ACK报文段，然后主机1进入TIME_WAIT状态；主机2收到主机1的ACK报文段以后，就关闭连接；此时，主机1等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机1也可以关闭连接了。

## XMPP

基础知识：

### presence 报文：通知性的报文(通知一些状态)：

1、加好友过程会发送presence，还不是好友的情况下会发送presence
2、通知好友好友上线下线

### iq 报文：操作性的报文

1、心跳包的发送
2、好友关系的建立，添加好友
3、群和用户关系的建立，群设置管理员，踢人，添加人

### message报文：消息性的报文(实际的消息)

1、就一般聊天发送的报文
2、一些通知性的报文：所有聊天类的消息
3、好友改变昵称头像(后台手动发送) 


### 思考：超长报文的收发怎么做到？

