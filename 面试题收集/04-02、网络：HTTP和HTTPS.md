# 04-02、网络：HTTP和HTTPS

## HTTP

超文本传送协议(Hypertext Transfer Protocol)

### HTTP的特性

HTTP构建于TCP/IP协议之上，默认端口号是80
HTTP是无连接无状态的
HTTP定义了与服务器交互的不同方法，最基本的方法有4种，分别是GET，POST，PUT，DELETE

HTTP 协议是以 ASCII 码传输，建立在 TCP/IP 协议之上的应用层规范。规范把 HTTP 请求分为三个部分：状态行、请求头、消息主体。类似于下面这样：

```
<method> <request-URL> <version>
<headers>
<entity-body>
```

### HTTP 常用状态码：

1. 1xx 消息：这一类型的状态码，代表请求已被接受，需要继续处理。
2. 2xx 成功：这一类型的状态码，代表请求已成功被服务器接收、理解、并接受。
    1. 200 OK
    2. 206 Partial Content（RFC 7233）
        1.  服务器已经成功处理了部分GET请求。
        2.  类似于FlashGet或者迅雷这类的 HTTP 下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。
3. 3xx 重定向：这类状态码代表需要客户端采取进一步的操作才能完成请求。
4. 4xx 客户端错误：这类的状态码代表了客户端看起来可能发生了错误，妨碍了服务器的处理。
    1. 400 Bad Request：由于明显的客户端错误（例如，格式错误的请求语法，太大的大小，无效的请求消息或欺骗性路由请求），服务器不能或不会处理该请求。
5. 5xx 服务器错误：表示服务器无法完成明显有效的请求。[56]这类状态码代表了服务器在处理请求的过程中有错误或者异常状态发生，也有可能是服务器意识到以当前的软硬件资源无法完成对请求的处理。
    1. 500 Internal Server Error：通用错误消息，服务器遇到了一个未曾预料的状况，导致了它无法完成对请求的处理。没有给出具体错误信息。

### HTTP 断点续传：

HTTP1.1协议（RFC2616）中定义了断点续传相关的HTTP头 Range和Content-Range字段，一个最简单的断点续传实现大概如下： 
  1. 客户端下载一个1024K的文件，已经下载了其中512K 
  2. 网络中断，客户端请求续传，因此需要在HTTP头中申明本次需要续传的片段： 
     `Range:bytes=512000-`
     这个头通知服务端从文件的512K位置开始传输文件 
  3. 服务端收到断点续传请求，从文件的512K位置开始传输，并且在HTTP头中增加： 
     `Content-Range:bytes 512000-/1024000` 
     并且此时服务端返回的HTTP状态码应该是206，而不是200。 

Range：
用于请求头中, 指定第一个字节的位置和最后一个字节的位置, 一般格式:
`Range:(unit=first byte pos)-[last byte pos]`

Content-Range：
用于响应头, 指定整个实体中的一部分的插入位置, 他也指示了整个实体的长度. 在服务器向客户返回一个部分响应, 它必须描述响应覆盖的范围和整个实体长度. 一般格式：
`Content-Range: bytes (unit first byte pos) - [last byte pos]/[entity legth]`

请求下载整个文件:

```
GET /test.rar HTTP/1.1
Connection: close
Host: 116.1.219.219
Range: bytes=0-801 // 一般请求下载整个文件是 bytes=0- 或不用这个头
```

一般正常回应：

```
HTTP/1.1 200 OK
Content-Length: 801
Content-Type: application/octet-stream
Content-Range: bytes 0-800/801 // 801: 文件总大小
```

### IP包分片原理

1. 数据链路层对数据帧的长度都有一个限制，也就是链路层所能承受的最大数据长度，这个值称为最大传输单元，即MTU。以以太网为例，这个值通常是1500字节。
2. 对于IP数据包来讲，也有一个长度，在IP包头中，以16位来描述IP包的长度，也就是说，一个IP包，最长可能是65535字节（多数网络设备将其限制在576字节以内）。
3. 结合以上两个概念，第一个重要的结论就出来了，如果IP包的大小，超过了MTU值，那么就需要分片，也就是把一个IP包分为多个，这个概念非常容易理解，一个载重5T的卡车，要拉10T的货，它当然就得分几次来拉了。
4. IP分片是很多资料常讲的内容，但是我倒是觉得分不分片其实不重要，重要的是另一个东西。一个数据包穿过一个大的网络，它其间会穿过多个网络，每个网络的MTU值是不同的。我们可以设想，如果接受/发送端都是以太网，它们的MTU都是1500，我们假设发送的时候，IP数据包会以1500来封装，然而，不幸的是，传输中有一段X.25网，它的MTU是576，这会发生什么呢？我想，这个才是我们所关心的。
5. 当然，结论是显而易见的，这个数据包会被再次分片，咱开始用火车拉，到了半路，不通火车，只通汽车，那一车货会被分为很多车……仅此而已，更重要的是，这种情况下，如果IP包被设置了“不允许分片标志”，那会发生些什么呢？对，数据包将被丢弃，然事收到一份ICMP（Internet Control Message Protocol，Internet控制报文协议）不可达差错，告诉你，需要分片！
6. 这个网络中最小的MTU值，被称为路径MTU，我们应该有一种有效的手段，来发现这个值，最笨的方法或许是先用traceroute查看所有节点，然后一个个ping。

　　
#### 一、IP分片原理：

![](http://oy7b0gogl.bkt.clouddn.com/F28C7C0F-B2C3-4C4A-A1CE-B4638F467FDE.png)

分片和重新组装的过程对于传输层是透明的，原因是IP数据报进行分片以后，只有它到达下一站时才可以 进行重新组装，且它是由目的端的IP层来完成的，分片之后的数据报根据需要可以再次 分片； IP分片和完整的报文差不多拥有相同的IP头,ID域对美英分片都是一致的，这样才能在进行组装的时候识别出来 同一个IP数据报文分片。在IP头里面：
* 16位识别号唯一记录了一个IP报的ID，具有同一个ID的IP分片将会重新进行组装；
* 而13位片偏移则记录了某IP片相对于整个包的位置；
* 这两个表中间的3位标志则标志着该分片后面是否还有新的分片。
这三个域组成了IP分片的所有信息，接受方可以利用这些信息对IP数据进行重新组装。

#### 二、IP分片步骤
一个未分片的数据报的分片信息字段全为0，即多个分片标志位为 0，并且偏移量 为0，分片一个数据报需要经过一下步骤
（1）检查DF标志位，查看是否允许分片，如果设置了该位，则数据报将被丢弃 ，并将ICMP错误返回给源端
（2）基于MTU值，把数据字段分成两个或对个部分，除了最后的数据 部分外，所有新建的数据选项 长度必须为8字节的倍数
（3）每个数据被放入一个IP数据报，这些数据报的包头略微改了原先的报文头
（4）除了最后的数据报分片外，所有的分片都设置了多个分片标志位
（5）每个分片中的片偏移量字段设为这个数据部分在原来数据报中所占的位置，这个位置相对于原来未分片数据报中的开头处。
（6）如果在原来的数据报中包括了选项，则选项类型字节的高位字节决定了这个信息是被复制到所有分片数据报，还是只复制到第一个数据报。
（7） 设置新数据报的报文头字段及总长度字段。
（8）重新计算报文头部校验和字段。
   此时这些分片数据报如一个完整的IP数据报一样被转发，IP独立的处理每个数据报分片，数据报分片能够通过不同的路由 ，到达目的，如果他们通过了那些规定了更小的MTU路由，还能够进一步对他们进行分片
    在目的主机上，数据被 重新组合成原来的数据报 ，发送主机设置的标示字段与数据报中的袁IP地址和目的IP地址一起使用，分片过程不改变这个字段

#### 三、重组
为了重新组合这些数据报分片，接受主机在第一个分片到达时分配一个存储缓冲区。这个主机还将启动一个计时器。当数据报的后续分片到达时，数据被复制到缓冲区存储器中片偏移量指定的位置，当所有分片都到达时，完整的未分片的原始数据报就被恢复了。
如果计时器超时并且分片保持尚未认可状态，则数据将被丢弃。这个计时器的初始值为IP数据报的生存期值，它依赖于实现的，一些实现允许对他进行配置。
重组步骤：
在接受方，一个由发送方发出的原始数据IP报，将所有的分片重新组合，才能够提交到上一层协议，每一个将被重组的IP数据报都用一个ipq结构来表示
为了能够有效提高组装分片，用于保存分片的结构必须做到以下几点
（1）快速定位某一个数据报的一组分组
（2）在属于某一个数据报的一组分片中快速插入新的分片
（3）有效的判断一个数据报的所有分片是否已经被全部接收
（4）具有重组超时机制，如果在重组完成之前超时溢出，则删除该数据报的所有内容

## HTTPS

